# Sistema de Gesti√≥n de Transporte

## üìã Descripci√≥n

Sistema integral de gesti√≥n de transporte de carga implementado con arquitectura de microservicios. Permite la administraci√≥n completa de empresas transportadoras, gesti√≥n de usuarios, veh√≠culos, conductores y √≥rdenes de transporte con seguimiento en tiempo real.

## üèóÔ∏è Arquitectura

### Microservicios

El sistema est√° compuesto por los siguientes microservicios independientes:

| Servicio | Puerto | Descripci√≥n |
|----------|--------|-------------|
| **auth-service** | 3001 | Autenticaci√≥n y autorizaci√≥n de usuarios |
| **users-service** | 3002 | Gesti√≥n de usuarios, roles y permisos |
| **companies-service** | 3003 | Gesti√≥n de empresas administradoras y clientes |
| **states-service** | 3004 | Gesti√≥n de estados del sistema |
| **travel-orders-service** | 3005 | Gesti√≥n de √≥rdenes de transporte |
| **database-migration** | 3006 | Migraciones y esquema de base de datos |

### Tecnolog√≠as

- **Framework**: NestJS con TypeScript
- **Base de Datos**: MySQL
- **ORM**: TypeORM
- **Comunicaci√≥n**: HTTP/REST con Axios
- **Validaci√≥n**: class-validator, class-transformer
- **Documentaci√≥n**: Joi para validaci√≥n de variables de entorno

## üóÑÔ∏è Modelo de Base de Datos

### Entidades Principales

#### üë• Gesti√≥n de Usuarios
- **users**: Datos principales de usuarios
- **users_secondary_data**: Informaci√≥n secundaria (fecha nacimiento, g√©nero, fotos)
- **drivers**: Conductores con licencias y documentaci√≥n
- **users_administratives**: Usuarios administrativos con cargo y dependencia
- **document_types**: Tipos de documentos de identificaci√≥n

#### üè¢ Gesti√≥n de Empresas
- **admin_companies**: Empresas administradoras/transportadoras
- **client_companies**: Empresas clientes que solicitan servicios
- **company_identification_types**: Tipos de identificaci√≥n empresarial
- **users_admin_companies**: Relaci√≥n usuarios-empresas (tabla transaccional)

#### üöõ Gesti√≥n de Transporte
- **travel_orders**: √ìrdenes de transporte
- **vehicles**: Veh√≠culos de transporte
- **vehicle_documents**: Documentaci√≥n de veh√≠culos (SOAT, tecnicomec√°nica)
- **travel_stop_points**: Puntos de parada en rutas
- **travel_current_location**: Ubicaci√≥n actual de veh√≠culos
- **delivery_documents**: Documentos de entrega

#### üîß Configuraci√≥n del Sistema
- **states**: Estados del sistema para control de flujos
- **roles**: Roles de usuario por empresa
- **permissions**: Permisos del sistema
- **load_capacity_categories**: Categor√≠as de capacidad de carga
- **load_type_categories**: Tipos de carga

### Relaciones Principales

```
Users (1:N) UsersAdminCompanies (N:1) AdminCompanies
Users (1:1) Drivers (N:M) Vehicles
AdminCompanies (1:N) TravelOrders (N:M) ClientCompanies
TravelOrders (1:N) TravelStopPoints (1:1) DeliveryDocuments
Roles (N:M) Permissions
```

## üöÄ Funcionalidades del Sistema

### **üîê Autenticaci√≥n y Seguridad**
- **JWT + Refresh Tokens**: Sistema de autenticaci√≥n seguro con tokens de acceso de corta duraci√≥n (15min) y refresh tokens de larga duraci√≥n (7 d√≠as)
- **Redis para Sesiones**: Almacenamiento en memoria para refresh tokens con expiraci√≥n autom√°tica
- **Roles Din√°micos**: Sistema de roles por empresa con permisos granulares configurables
- **Verificaci√≥n de Documentos**: Proceso completo de verificaci√≥n manual de documentos con estados de flujo
- **Guards de Autorizaci√≥n**: Protecci√≥n de endpoints basada en roles y permisos espec√≠ficos

### **üë• Gesti√≥n Avanzada de Usuarios**
- **Usuarios Multientidad**: Un usuario puede pertenecer a m√∫ltiples empresas con roles diferentes
- **Conductores Especializados**: Gesti√≥n completa de licencias, categor√≠as y documentaci√≥n legal
- **Usuarios Administrativos**: Roles espec√≠ficos con cargos y dependencias organizacionales
- **Datos Secundarios**: Informaci√≥n extendida con fotos de perfil, documentos y historial de sesiones
- **Estados de Verificaci√≥n**: Control granular del estado de cada usuario seg√∫n su tipo y verificaci√≥n

### **üè¢ Gesti√≥n Empresarial Integral**
- **Empresas Administradoras**: Gesti√≥n completa de empresas transportadoras con verificaci√≥n legal
- **Empresas Fantasma**: Creaci√≥n autom√°tica para conductores naturales sin empresa formal
- **Empresas Cliente**: Registro referencial para tracking de servicios prestados
- **Configuraci√≥n Personalizada**: JSON config para ajustes espec√≠ficos por empresa
- **Verificaci√≥n DIAN**: Proceso de verificaci√≥n manual con datos oficiales

### **üöõ Gesti√≥n de Transporte Completa**
- **Veh√≠culos con Documentaci√≥n**: Control completo de SOAT, tecnicomec√°nica, tarjetas de propiedad
- **Asignaci√≥n Din√°mica**: Conductores asignados a veh√≠culos con posibilidad de m√∫ltiples asignaciones
- **Categor√≠as de Carga**: Sistema de clasificaci√≥n por tipo y capacidad de carga
- **√ìrdenes Flexibles**: Posibilidad de cambiar veh√≠culos durante el transporte por eventualidades
- **Seguimiento en Tiempo Real**: Ubicaci√≥n GPS actualizada constantemente

### **üìä Control de Flujos y Estados**
- **Estados Centralizados**: Gesti√≥n unificada de todos los estados del sistema desde un servicio dedicado
- **Transiciones Controladas**: Flujos predefinidos para cambios de estado con validaciones
- **Historial de Cambios**: Tracking completo de modificaciones y transiciones
- **Estados Espec√≠ficos**: Diferentes estados para usuarios, conductores, veh√≠culos, empresas, etc.

### **üì± Aplicaci√≥n M√≥vil y Web**
- **Autoregistro M√≥vil**: √önica forma para que conductores naturales se registren en el sistema
- **Panel de Administraci√≥n Web**: Gesti√≥n completa para admins de empresa y super usuarios
- **Marketplace Integrado**: Plataforma para conexi√≥n entre oferta y demanda de transporte
- **Notificaciones en Tiempo Real**: Sistema de alertas y actualizaciones (futuro)

## üõ†Ô∏è Instalaci√≥n y Configuraci√≥n

### Prerrequisitos
- **Node.js** >= 18.0.0
- **MySQL** >= 8.0
- **Redis** >= 6.0 (para auth-service)
- **pnpm** (recomendado) o npm >= 8.0

### Variables de Entorno por Servicio

#### **Auth-Service (.env)**
```env
# Servidor
AUTH_SERVICE_PORT=3001

# Base de datos dedicada
AUTH_DB_HOST=localhost
AUTH_DB_PORT=3306
AUTH_DB_NAME=auth_transporte_db
AUTH_DB_USERNAME=root
AUTH_DB_PASSWORD=password

# JWT Configuration
JWT_SECRET=your-super-secret-jwt-key-min-32-chars
JWT_ACCESS_EXPIRATION=15m
JWT_REFRESH_EXPIRATION=7d

# Redis para refresh tokens
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=

# File Upload
UPLOAD_PATH=./uploads
MAX_FILE_SIZE=5242880
ALLOWED_FILE_TYPES=jpg,jpeg,png,pdf

# Servicios externos
USERS_SERVICE_URL=http://localhost:3002
COMPANIES_SERVICE_URL=http://localhost:3003
STATES_SERVICE_URL=http://localhost:3004
```

#### **Users-Service (.env)**
```env
# Servidor
APP_PORT=3002

# Base de datos principal
DB_HOST=localhost
DB_PORT=3306
DB_NAME=transporte_db
DB_USERNAME=root
DB_PASSWORD=password

# Servicios externos
STATES_SERVICE_URL=http://localhost:3004
COMPANIES_SERVICE_URL=http://localhost:3003
```

#### **Companies-Service (.env)**
```env
# Servidor
APP_PORT=3003

# Base de datos principal
DB_HOST=localhost
DB_PORT=3306
DB_NAME=transporte_db
DB_USERNAME=root
DB_PASSWORD=password

# Servicios externos
USERS_SERVICE_URL=http://localhost:3002
STATES_SERVICE_URL=http://localhost:3004
```

#### **States-Service (.env)**
```env
# Servidor
APP_PORT=3004

# Base de datos principal
DB_HOST=localhost
DB_PORT=3306
DB_NAME=transporte_db
DB_USERNAME=root
DB_PASSWORD=password
```

#### **Travel-Orders-Service (.env)**
```env
# Servidor
APP_PORT=3005

# Base de datos principal
DB_HOST=localhost
DB_PORT=3306
DB_NAME=transporte_db
DB_USERNAME=root
DB_PASSWORD=password

# Servicios externos
USERS_SERVICE_URL=http://localhost:3002
COMPANIES_SERVICE_URL=http://localhost:3003
STATES_SERVICE_URL=http://localhost:3004

# Redis para tiempo real (futuro)
REDIS_HOST=localhost
REDIS_PORT=6379
```

#### **Database-Migration (.env)**
```env
# Servidor
APP_PORT=3006

# Base de datos principal
DB_HOST=localhost
DB_PORT=3306
DB_NAME=transporte_db
DB_USERNAME=root
DB_PASSWORD=password
```

### Instalaci√≥n Paso a Paso

1. **Clonar el repositorio**
```bash
git clone <repository-url>
cd sftw-transporte
```

2. **Configurar bases de datos**
```sql
-- Crear base de datos principal
CREATE DATABASE transporte_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- Crear base de datos para auth-service
CREATE DATABASE auth_transporte_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

3. **Instalar Redis (Windows)**
```bash
# Usando Chocolatey
choco install redis-64

# O descargar desde: https://github.com/microsoftarchive/redis/releases
```

4. **Instalar dependencias en cada servicio**
```bash
# Database Migration (ejecutar primero)
cd database-migration
pnpm install
copy .env.example .env
# Configurar variables de entorno
pnpm run start:dev

# Auth Service
cd ..\auth-service
pnpm install
copy .env.example .env
# Configurar variables de entorno

# Users Service
cd ..\users-service
pnpm install

# Companies Service
cd ..\companies-service
pnpm install

# States Service
cd ..\states-service
pnpm install

# Travel Orders Service
cd ..\travel-orders-service
pnpm install
```

5. **Ejecutar servicios en orden**
```bash
# Terminal 1: Database Migration (solo la primera vez)
cd database-migration
pnpm run start:dev

# Terminal 2: States Service (debe estar disponible para otros)
cd states-service
pnpm run start:dev

# Terminal 3: Users Service
cd users-service
pnpm run start:dev

# Terminal 4: Companies Service
cd companies-service
pnpm run start:dev

# Terminal 5: Auth Service
cd auth-service
pnpm run start:dev

# Terminal 6: Travel Orders Service
cd travel-orders-service
pnpm run start:dev
```

### Verificaci√≥n de Instalaci√≥n

1. **Verificar servicios activos**
```bash
# Estados
curl http://localhost:3004/states

# Usuarios
curl http://localhost:3002/document-types

# Empresas
curl http://localhost:3003/company-identification-types

# Auth (deber√≠a requerir autenticaci√≥n)
curl http://localhost:3001/auth/me
```

2. **Verificar Redis**
```bash
redis-cli ping
# Deber√≠a responder: PONG
```

3. **Verificar Base de Datos**
```sql
USE transporte_db;
SHOW TABLES;
-- Deber√≠a mostrar todas las tablas migradas
```

## üîß Servicios y Funcionalidades Detalladas

### **üîê Auth-Service (Puerto 3001)**
**Responsabilidad**: Autenticaci√≥n, autorizaci√≥n y verificaci√≥n de documentos

**Funcionalidades**:
- Gesti√≥n completa del ciclo de autenticaci√≥n (login, logout, refresh tokens)
- Proceso de registro para todos los tipos de entidades
- Verificaci√≥n y aprobaci√≥n de documentos subidos
- Coordinaci√≥n con otros servicios para creaci√≥n de entidades verificadas
- Almacenamiento temporal de documentos y procesos de verificaci√≥n
- Manejo de refresh tokens con Redis

**Base de Datos Propia**: 
- Tablas de verificaci√≥n, documentos subidos, tokens de refresh
- Logs de autenticaci√≥n y procesos de verificaci√≥n

### **üë• Users-Service (Puerto 3002)**
**Responsabilidad**: Gesti√≥n integral de usuarios y sistema de permisos

**Funcionalidades**:
- CRUD completo de usuarios con datos principales y secundarios
- Gesti√≥n de conductores con licencias y documentaci√≥n
- Usuarios administrativos con cargos y dependencias
- Sistema de roles por empresa con permisos granulares
- Gesti√≥n de tipos de documentos de identificaci√≥n
- Relaciones usuario-empresa a trav√©s de tablas transaccionales

**Entidades Principales**: users, users_secondary_data, drivers, user_administratives, roles, permissions, document_types

### **üè¢ Companies-Service (Puerto 3003)**
**Responsabilidad**: Gesti√≥n de empresas y veh√≠culos

**Funcionalidades**:
- Gesti√≥n de empresas administradoras/transportadoras verificadas
- Registro de empresas clientes (solo referenciales)
- Gesti√≥n completa de veh√≠culos con documentaci√≥n
- Tipos de identificaci√≥n empresarial
- Relaciones empresa-usuario y conductor-veh√≠culo
- Gesti√≥n de empresas fantasma para conductores naturales

**Entidades Principales**: admin_companies, client_companies, vehicles, vehicle_documents, company_identification_types

### **üìä States-Service (Puerto 3004)**
**Responsabilidad**: Gesti√≥n centralizada de todos los estados del sistema

**Funcionalidades**:
- Estados para usuarios, conductores, veh√≠culos, empresas
- Estados para roles, permisos y procesos de verificaci√≥n
- Control de flujos y transiciones de estado
- Disponible para todos los servicios del ecosistema

**Entidades**: states (tabla √∫nica centralizada)

### **üöõ Travel-Orders-Service (Puerto 3005)**
**Responsabilidad**: Gesti√≥n completa de √≥rdenes de transporte

**Funcionalidades**:
- Creaci√≥n y gesti√≥n de √≥rdenes de transporte
- Puntos de parada y rutas de entrega
- Seguimiento en tiempo real de ubicaci√≥n
- Gesti√≥n de novedades y reportes de viaje
- Documentos de entrega y comprobantes
- Historial de veh√≠culos asignados por orden

**Entidades Principales**: travel_orders, travel_stop_points, travel_current_location, travel_news, delivery_documents

### **üóÑÔ∏è Database-Migration (Puerto 3006)**
**Responsabilidad**: Gesti√≥n del esquema de base de datos

**Funcionalidades**:
- Creaci√≥n y actualizaci√≥n del esquema completo
- Migraciones de estructura de base de datos
- Datos iniciales y seeds
- Sincronizaci√≥n autom√°tica de entidades

## üì° API Endpoints Detallados

### **üîê Auth-Service (Puerto 3001)**

#### **Autenticaci√≥n**
| M√©todo | Ruta | Prop√≥sito | Descripci√≥n |
|--------|------|-----------|-------------|
| ‚úÖ POST | `/auth/login` | Iniciar sesi√≥n | Autenticaci√≥n con email/password, retorna JWT + refresh token |
| ‚úÖ POST | `/auth/refresh` | Renovar token | Intercambia refresh token por nuevo JWT |
| ‚úÖ POST | `/auth/logout` | Cerrar sesi√≥n | Invalida refresh token y cierra sesi√≥n |
| ‚úÖ GET | `/auth/me` | Perfil usuario | Obtiene informaci√≥n del usuario autenticado |

#### **Registro**
| M√©todo | Ruta | Prop√≥sito | Descripci√≥n |
|--------|------|-----------|-------------|
| ‚úÖ POST | `/auth/register-natural-driver` | Registro conductor natural | Registro desde app m√≥vil (conductor + veh√≠culo) |
| ‚úÖ POST | `/auth/register-driver` | Registro conductor empresa | Admin registra conductor para su empresa |
| ‚úÖ POST | `/auth/register-vehicle` | Registro veh√≠culo | Registro de veh√≠culo por admin o conductor |
| ‚úÖ POST | `/auth/register-company` | Registro empresa | Solo super usuario registra empresas |
| ‚úÖ POST | `/auth/register-user` | Registro usuario simple | Usuario administrativo sin roles especiales |

#### **Gesti√≥n de Documentos**
| M√©todo | Ruta | Prop√≥sito | Descripci√≥n |
|--------|------|-----------|-------------|
| ‚úÖ POST | `/auth/upload-driver-docs/:id` | Subir docs conductor | Upload de c√©dula, licencia, foto personal |
| ‚úÖ POST | `/auth/upload-vehicle-docs/:id` | Subir docs veh√≠culo | Upload de SOAT, tecnicomec√°nica, tarjeta propiedad |
| ‚úÖ GET | `/auth/pending-verifications` | Listar pendientes | Lista de documentos pendientes por verificar |
| ‚úÖ GET | `/auth/verification/:id/documents` | Ver documentos | Visualizar documentos subidos para verificaci√≥n |

#### **Verificaci√≥n (Solo Admins)**
| M√©todo | Ruta | Prop√≥sito | Descripci√≥n |
|--------|------|-----------|-------------|
| ‚úÖ PUT | `/auth/verify-driver/:id` | Verificar conductor | Aprobar/rechazar conductor tras revisar docs |
| ‚úÖ PUT | `/auth/verify-vehicle/:id` | Verificar veh√≠culo | Aprobar/rechazar veh√≠culo tras revisar docs |
| ‚úÖ PUT | `/auth/verify-company/:id` | Verificar empresa | Solo super usuario verifica empresas |

### **üë• Users-Service (Puerto 3002)**

#### **Gesti√≥n de Usuarios**
| M√©todo | Ruta | Prop√≥sito | Descripci√≥n |
|--------|------|-----------|-------------|
| ‚úÖ GET | `/users` | Listar usuarios | Lista paginada de usuarios con filtros |
| ‚úÖ GET | `/users/:id` | Obtener usuario | Detalle completo de usuario espec√≠fico |
| ‚úÖ POST | `/users` | Crear usuario | Creaci√≥n manual de usuario (desde auth-service) |
| ‚úÖ PUT | `/users/:id` | Actualizar usuario | Modificar datos de usuario existente |
| ‚úÖ DELETE | `/users/:id` | Eliminar usuario | Eliminaci√≥n l√≥gica de usuario |
| ‚úÖ GET | `/users/:id/companies` | Empresas del usuario | Lista empresas donde trabaja el usuario |

#### **Gesti√≥n de Conductores**
| M√©todo | Ruta | Prop√≥sito | Descripci√≥n |
|--------|------|-----------|-------------|
| ‚úÖ GET | `/drivers` | Listar conductores | Lista de conductores con estado de verificaci√≥n |
| ‚úÖ GET | `/drivers/:id` | Obtener conductor | Detalle de conductor con licencias |
| ‚úÖ PUT | `/drivers/:id/state` | Cambiar estado | Actualizar estado de verificaci√≥n del conductor |
| ‚úÖ GET | `/drivers/:id/vehicles` | Veh√≠culos asignados | Lista veh√≠culos asignados al conductor |

#### **Sistema de Roles y Permisos**
| M√©todo | Ruta | Prop√≥sito | Descripci√≥n |
|--------|------|-----------|-------------|
| ‚úÖ GET | `/roles` | Listar roles | Todos los roles del sistema |
| ‚úÖ GET | `/roles/company/:id` | Roles por empresa | Roles espec√≠ficos de una empresa |
| ‚úÖ POST | `/roles` | Crear rol | Nuevo rol con permisos asignados |
| ‚úÖ PUT | `/roles/:id` | Actualizar rol | Modificar rol y sus permisos |
| ‚úÖ DELETE | `/roles/:id` | Eliminar rol | Eliminar rol si no tiene usuarios asignados |
| ‚úÖ GET | `/permissions` | Listar permisos | Todos los permisos disponibles |
| ‚úÖ POST | `/permissions` | Crear permiso | Nuevo permiso del sistema |
| ‚úÖ PUT | `/permissions/:id` | Actualizar permiso | Modificar permiso existente |

#### **Tipos de Documentos**
| M√©todo | Ruta | Prop√≥sito | Descripci√≥n |
|--------|------|-----------|-------------|
| ‚úÖ GET | `/document-types` | Listar tipos | Tipos de documentos disponibles |
| ‚úÖ GET | `/document-types/entity/:type` | Por entidad | Documentos requeridos por tipo de entidad |

### **üè¢ Companies-Service (Puerto 3003)**

#### **Empresas Administradoras**
| M√©todo | Ruta | Prop√≥sito | Descripci√≥n |
|--------|------|-----------|-------------|
| ‚úÖ GET | `/admin-companies` | Listar empresas admin | Empresas transportadoras con paginaci√≥n |
| ‚úÖ GET | `/admin-companies/:id` | Obtener empresa | Detalle completo de empresa administradora |
| ‚úÖ POST | `/admin-companies` | Crear empresa | Nueva empresa (desde auth-service) |
| ‚úÖ PUT | `/admin-companies/:id` | Actualizar empresa | Modificar datos de empresa |
| ‚úÖ PUT | `/admin-companies/:id/state` | Cambiar estado | Actualizar estado de verificaci√≥n |
| ‚úÖ GET | `/admin-companies/:id/users` | Usuarios empresa | Lista usuarios asignados a la empresa |
| ‚úÖ GET | `/admin-companies/:id/vehicles` | Veh√≠culos empresa | Lista veh√≠culos de la empresa |

#### **Empresas Clientes**
| M√©todo | Ruta | Prop√≥sito | Descripci√≥n |
|--------|------|-----------|-------------|
| ‚úÖ GET | `/client-companies` | Listar clientes | Empresas clientes para referenciar en √≥rdenes |
| ‚úÖ POST | `/client-companies` | Crear cliente | Nueva empresa cliente |
| ‚úÖ PUT | `/client-companies/:id` | Actualizar cliente | Modificar datos de empresa cliente |

#### **Gesti√≥n de Veh√≠culos**
| M√©todo | Ruta | Prop√≥sito | Descripci√≥n |
|--------|------|-----------|-------------|
| ‚úÖ GET | `/vehicles` | Listar veh√≠culos | Veh√≠culos con estado y empresa |
| ‚úÖ GET | `/vehicles/:id` | Obtener veh√≠culo | Detalle de veh√≠culo con documentos |
| ‚úÖ POST | `/vehicles` | Crear veh√≠culo | Nuevo veh√≠culo (desde auth-service) |
| ‚úÖ PUT | `/vehicles/:id` | Actualizar veh√≠culo | Modificar datos del veh√≠culo |
| ‚úÖ PUT | `/vehicles/:id/state` | Cambiar estado | Actualizar estado de verificaci√≥n |
| ‚úÖ GET | `/vehicles/:id/drivers` | Conductores asignados | Lista conductores del veh√≠culo |
| ‚úÖ POST | `/vehicles/:id/assign-driver` | Asignar conductor | Vincular conductor verificado al veh√≠culo |

#### **Configuraci√≥n**
| M√©todo | Ruta | Prop√≥sito | Descripci√≥n |
|--------|------|-----------|-------------|
| ‚úÖ GET | `/company-identification-types` | Tipos identificaci√≥n | Tipos de ID para empresas (NIT, RUT, etc.) |

### **üìä States-Service (Puerto 3004)**

#### **Gesti√≥n de Estados**
| M√©todo | Ruta | Prop√≥sito | Descripci√≥n |
|--------|------|-----------|-------------|
| ‚úÖ GET | `/states` | Listar estados | Todos los estados del sistema |
| ‚úÖ GET | `/states/:id` | Obtener estado | Detalle de estado espec√≠fico |
| ‚úÖ PUT | `/states/:id` | Actualizar estado | Modificar nombre o descripci√≥n |
| ‚úÖ GET | `/states/entity/:type` | Estados por entidad | Estados espec√≠ficos para users, drivers, etc. |

### **üöõ Travel-Orders-Service (Puerto 3005)**

#### **√ìrdenes de Transporte**
| M√©todo | Ruta | Prop√≥sito | Descripci√≥n |
|--------|------|-----------|-------------|
| üîÑ GET | `/travel-orders` | Listar √≥rdenes | √ìrdenes con filtros y paginaci√≥n |
| üîÑ GET | `/travel-orders/:id` | Obtener orden | Detalle completo de orden de transporte |
| üîÑ POST | `/travel-orders` | Crear orden | Nueva orden de transporte |
| üîÑ PUT | `/travel-orders/:id` | Actualizar orden | Modificar datos de la orden |
| üîÑ PUT | `/travel-orders/:id/assign-vehicle` | Asignar veh√≠culo | Vincular veh√≠culo a la orden |
| üîÑ PUT | `/travel-orders/:id/change-vehicle` | Cambiar veh√≠culo | Reemplazar veh√≠culo durante viaje |

#### **Seguimiento y Ubicaci√≥n**
| M√©todo | Ruta | Prop√≥sito | Descripci√≥n |
|--------|------|-----------|-------------|
| üîÑ GET | `/travel-orders/:id/location` | Ubicaci√≥n actual | Coordenadas actuales del veh√≠culo |
| üîÑ PUT | `/travel-orders/:id/location` | Actualizar ubicaci√≥n | Conductor reporta nueva posici√≥n |
| üîÑ GET | `/travel-orders/:id/route` | Ruta completa | Historial de ubicaciones del viaje |

#### **Puntos de Parada**
| M√©todo | Ruta | Prop√≥sito | Descripci√≥n |
|--------|------|-----------|-------------|
| üîÑ GET | `/travel-orders/:id/stop-points` | Puntos de parada | Lista puntos de entrega de la orden |
| üîÑ POST | `/travel-orders/:id/stop-points` | Agregar punto | Nuevo punto de parada |
| üîÑ PUT | `/stop-points/:id/complete` | Marcar completado | Conductor marca punto como entregado |
| üîÑ POST | `/stop-points/:id/documents` | Subir comprobante | Documentos de entrega del punto |

#### **Novedades y Reportes**
| M√©todo | Ruta | Prop√≥sito | Descripci√≥n |
|--------|------|-----------|-------------|
| üîÑ GET | `/travel-orders/:id/news` | Listar novedades | Reportes e incidencias del viaje |
| üîÑ POST | `/travel-orders/:id/news` | Reportar novedad | Conductor reporta incidencia |

### **üóÑÔ∏è Database-Migration (Puerto 3006)**

#### **Gesti√≥n de Esquema**
| M√©todo | Ruta | Prop√≥sito | Descripci√≥n |
|--------|------|-----------|-------------|
| ‚úÖ GET | `/health` | Estado del servicio | Verificar conectividad de base de datos |
| ‚úÖ POST | `/migrate` | Ejecutar migraciones | Aplicar cambios de esquema |
| ‚úÖ GET | `/schema` | Ver esquema actual | Estado actual de las tablas |

**Leyenda**: ‚úÖ Implementado | üîÑ En desarrollo | ‚è≥ Pendiente

## üîí Seguridad y Arquitectura

### **Autenticaci√≥n y Autorizaci√≥n**
- **JWT con Refresh Tokens**: Tokens de acceso de corta duraci√≥n (15 min) + refresh tokens de larga duraci√≥n (7 d√≠as)
- **Redis para Gesti√≥n de Sesiones**: Almacenamiento en memoria con expiraci√≥n autom√°tica
- **Encriptaci√≥n BCrypt**: Hash seguro de contrase√±as con salt rounds configurables
- **Guards Personalizados**: Protecci√≥n de endpoints con validaci√≥n de roles y permisos
- **Estrategias Passport**: Implementaci√≥n de estrategias JWT y Local para flexibilidad

### **Validaci√≥n y Consistencia de Datos**
- **Class-Validator**: Validaci√≥n robusta en DTOs con decoradores personalizados
- **Joi para Variables de Entorno**: Validaci√≥n estricta de configuraci√≥n al inicio
- **Transformaci√≥n de Datos**: Normalizaci√≥n autom√°tica con class-transformer
- **Manejo Centralizado de Errores**: Respuestas consistentes en todos los servicios
- **Logging Estructurado**: Logs detallados para auditor√≠a y debugging

### **Comunicaci√≥n entre Servicios**
- **HTTP/REST**: Comunicaci√≥n s√≠ncrona con manejo de errores y reintentos
- **Base Integration Service**: Clase base para comunicaci√≥n con patrones consistentes
- **Circuit Breaker Pattern**: Prevenci√≥n de fallos en cascada (futuro)
- **Service Discovery**: URLs configurables por ambiente

### **Base de Datos y Persistencia**
- **TypeORM**: ORM robusto con migraciones autom√°ticas y relaciones complejas
- **M√∫ltiples Bases de Datos**: Separaci√≥n l√≥gica auth-service vs servicios principales
- **Transacciones**: Manejo de operaciones complejas con rollback autom√°tico
- **√çndices Optimizados**: Performance mejorado en consultas frecuentes
- **Soft Deletes**: Eliminaci√≥n l√≥gica para mantenimiento de historial

### **Escalabilidad y Performance**
- **Arquitectura de Microservicios**: Escalado independiente por servicio
- **Redis Cache**: Almacenamiento en memoria para datos de acceso frecuente
- **Paginaci√≥n Inteligente**: Control de carga en endpoints de listado
- **Lazy Loading**: Carga bajo demanda de relaciones pesadas
- **Connection Pooling**: Gesti√≥n eficiente de conexiones a base de datos

## üè¢ Arquitectura del Sistema

### **Patr√≥n de Microservicios**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Auth        ‚îÇ    ‚îÇ Users       ‚îÇ    ‚îÇ Companies   ‚îÇ
‚îÇ Service     ‚îÇ‚óÑ‚îÄ‚îÄ‚ñ∫‚îÇ Service     ‚îÇ‚óÑ‚îÄ‚îÄ‚ñ∫‚îÇ Service     ‚îÇ
‚îÇ :3001       ‚îÇ    ‚îÇ :3002       ‚îÇ    ‚îÇ :3003       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ                   ‚îÇ                   ‚îÇ
       ‚îÇ                   ‚îÇ                   ‚îÇ
       ‚ñº                   ‚ñº                   ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ States      ‚îÇ    ‚îÇ Travel      ‚îÇ    ‚îÇ Database    ‚îÇ
‚îÇ Service     ‚îÇ    ‚îÇ Orders      ‚îÇ    ‚îÇ Migration   ‚îÇ
‚îÇ :3004       ‚îÇ    ‚îÇ Service     ‚îÇ    ‚îÇ :3006       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ :3005       ‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### **Flujo de Datos**
```
üì± Mobile App ‚îÄ‚îÄ‚Üí Auth Service ‚îÄ‚îÄ‚Üí Users/Companies Service
                      ‚îÇ                       ‚îÇ
                      ‚ñº                       ‚ñº
üñ•Ô∏è Web Panel ‚îÄ‚îÄ‚Üí Redis Cache ‚îÄ‚îÄ‚Üí MySQL Database
                      ‚îÇ                       ‚îÇ
                      ‚ñº                       ‚ñº
üìä Admin Panel ‚îÄ‚îÄ‚Üí States Service ‚îÄ‚îÄ‚Üí Travel Orders Service
```

### **Separaci√≥n de Responsabilidades**

#### **Capa de Presentaci√≥n**
- Controllers: Manejo de requests HTTP y validaci√≥n de entrada
- DTOs: Definici√≥n de estructura de datos de entrada y salida
- Guards: Validaci√≥n de autenticaci√≥n y autorizaci√≥n

#### **Capa de Negocio**
- Services: L√≥gica de negocio principal
- Integration Services: Comunicaci√≥n entre microservicios
- Utilities: Funciones auxiliares y helpers

#### **Capa de Datos**
- Entities: Definici√≥n de modelo de datos con TypeORM
- Repositories: Acceso a datos con patrones de consulta
- Migrations: Control de versiones de esquema de base de datos

## üìä Monitoreo y Observabilidad

### **Logging**
- **Structured Logging**: JSON logs con contexto completo
- **Correlation IDs**: Tracking de requests entre servicios
- **Error Tracking**: Captura detallada de excepciones
- **Performance Metrics**: Tiempo de respuesta por endpoint

### **Health Checks**
- **Service Health**: Endpoints /health en cada servicio
- **Database Connectivity**: Verificaci√≥n de conexiones
- **External Dependencies**: Status de servicios externos
- **Resource Usage**: Memoria, CPU, conexiones activas

### **M√©tricas (Futuro)**
- **Request Metrics**: Throughput, latencia, error rate
- **Business Metrics**: √ìrdenes completadas, usuarios activos
- **Infrastructure Metrics**: CPU, memoria, disco
- **Custom Dashboards**: Visualizaci√≥n en tiempo real

## üè¢ Estructura del Proyecto

```
sftw-transporte/
‚îú‚îÄ‚îÄ auth-service/           # Autenticaci√≥n
‚îú‚îÄ‚îÄ users-service/          # Gesti√≥n de usuarios
‚îú‚îÄ‚îÄ companies-service/      # Gesti√≥n de empresas
‚îú‚îÄ‚îÄ states-service/         # Estados del sistema
‚îú‚îÄ‚îÄ travel-orders-service/  # √ìrdenes de transporte
‚îú‚îÄ‚îÄ database-migration/     # Migraciones DB
‚îî‚îÄ‚îÄ README.md
```

## üìà Estado del Desarrollo y Roadmap

### **‚úÖ Completado**
- **Base de Datos**: Esquema completo con 25+ entidades y relaciones complejas
- **Users-Service**: CRUD completo de usuarios, conductores, roles y permisos
- **Companies-Service**: Gesti√≥n de empresas administradoras, clientes y veh√≠culos  
- **States-Service**: Gesti√≥n centralizada de estados del sistema
- **Database-Migration**: Servicio de migraciones y esquema inicial
- **Integraci√≥n entre Servicios**: Comunicaci√≥n HTTP con manejo de errores
- **Validaci√≥n de Datos**: DTOs con class-validator en todos los servicios
- **Arquitectura Base**: Estructura de microservicios establecida

### **üîÑ En Desarrollo**
- **Auth-Service**: 
  - ‚úÖ Estructura base y configuraci√≥n
  - üîÑ Sistema de autenticaci√≥n JWT + Redis
  - üîÑ Proceso de registro y verificaci√≥n de documentos
  - üîÑ Integraci√≥n con otros servicios para creaci√≥n de entidades
- **Travel-Orders-Service**:
  - ‚úÖ Estructura base definida
  - üîÑ CRUD de √≥rdenes de transporte
  - üîÑ Sistema de seguimiento en tiempo real
  - üîÑ Gesti√≥n de puntos de parada y entregas

### **‚è≥ Pr√≥ximas Fases**

#### **Fase 1: Core Authentication (2-3 semanas)**
- üîÑ Completar auth-service con todas las funcionalidades
- üîÑ Implementar guards y estrategias de autenticaci√≥n
- üîÑ Sistema completo de verificaci√≥n de documentos
- üîÑ Integraci√≥n Redis para refresh tokens

#### **Fase 2: Travel Management (3-4 semanas)**
- ‚è≥ Completar travel-orders-service
- ‚è≥ Sistema de seguimiento GPS en tiempo real
- ‚è≥ Gesti√≥n avanzada de rutas y puntos de entrega
- ‚è≥ Reportes y novedades de viaje

#### **Fase 3: Mobile Application (4-6 semanas)**
- ‚è≥ Aplicaci√≥n m√≥vil para conductores (React Native)
- ‚è≥ Autoregistro y verificaci√≥n de documentos
- ‚è≥ Recepci√≥n y gesti√≥n de √≥rdenes
- ‚è≥ Tracking en tiempo real y reportes

#### **Fase 4: Web Dashboard (3-4 semanas)**
- ‚è≥ Panel de administraci√≥n para super usuarios
- ‚è≥ Dashboard para administradores de empresa
- ‚è≥ Sistema de verificaci√≥n de documentos
- ‚è≥ Reportes y analytics

#### **Fase 5: Marketplace (4-5 semanas)**
- ‚è≥ Plataforma de ofertas de transporte
- ‚è≥ Sistema de matching autom√°tico
- ‚è≥ Gesti√≥n de tarifas y pagos
- ‚è≥ Sistema de calificaciones

#### **Fase 6: Advanced Features (6-8 semanas)**
- ‚è≥ Sistema de notificaciones (email, SMS, push)
- ‚è≥ Inteligencia artificial para optimizaci√≥n de rutas
- ‚è≥ Sistema de pagos integrado
- ‚è≥ Reportes avanzados y business intelligence
- ‚è≥ API p√∫blica para terceros

### **üõ°Ô∏è Funcionalidades de Seguridad Pendientes**
- ‚è≥ Rate limiting y throttling
- ‚è≥ Encriptaci√≥n de datos sensibles
- ‚è≥ Auditor√≠a completa de acciones
- ‚è≥ Backup autom√°tico y disaster recovery
- ‚è≥ Compliance con normativas de protecci√≥n de datos

### **‚ö° Optimizaciones de Performance**
- ‚è≥ Cache distribuido con Redis Cluster
- ‚è≥ CDN para archivos est√°ticos
- ‚è≥ Optimizaci√≥n de consultas de base de datos
- ‚è≥ Implementaci√≥n de CQRS para operaciones pesadas
- ‚è≥ Load balancing entre instancias

### **üìä M√©tricas y Monitoreo**
- ‚è≥ Implementaci√≥n de Prometheus + Grafana
- ‚è≥ APM (Application Performance Monitoring)
- ‚è≥ Log aggregation con ELK Stack
- ‚è≥ Alerting automatizado
- ‚è≥ Health checks avanzados

### **üîß DevOps y Deployment**
- ‚è≥ Containerizaci√≥n con Docker
- ‚è≥ Orquestaci√≥n con Kubernetes
- ‚è≥ CI/CD pipelines automatizados
- ‚è≥ Infrastructure as Code
- ‚è≥ Environments de staging y producci√≥n

## üéØ Objetivos del Proyecto

### **Objetivos T√©cnicos**
- ‚úÖ Arquitectura escalable de microservicios
- üîÑ Sistema de autenticaci√≥n robusto y seguro
- ‚è≥ Performance √≥ptimo para 10,000+ usuarios concurrentes
- ‚è≥ Disponibilidad 99.9% con disaster recovery
- ‚è≥ API RESTful completa y documentada

### **Objetivos de Negocio**
- ‚è≥ Digitalizaci√≥n completa de procesos de transporte
- ‚è≥ Marketplace competitivo en el sector log√≠stico
- ‚è≥ Reducci√≥n de tiempos de gesti√≥n en 70%
- ‚è≥ Aumento de transparencia y trazabilidad
- ‚è≥ Expansi√≥n a mercados regionales

### **Objetivos de Usuario**
- ‚è≥ Interfaz intuitiva para todos los tipos de usuario
- ‚è≥ Proceso de registro simplificado
- ‚è≥ Tracking en tiempo real confiable
- ‚è≥ Gesti√≥n eficiente de documentaci√≥n
- ‚è≥ Soporte 24/7 integrado

## üë• Contribuci√≥n

1. Fork el proyecto
2. Crear una rama para la feature (`git checkout -b feature/AmazingFeature`)
3. Commit los cambios (`git commit -m 'Add some AmazingFeature'`)
4. Push a la rama (`git push origin feature/AmazingFeature`)
5. Abrir un Pull Request

## üîÑ Procesos y Flujos del Sistema

### **1. Registro de Conductor Persona Natural (App M√≥vil)**
*√öNICA forma de autoregistro en el sistema*

```
üì± Descarga app m√≥vil ‚Üí üìù Registro b√°sico ‚Üí üìß Verificaci√≥n email
    ‚Üì
üì∏ Subida documentos conductor ‚Üí üì∏ Subida documentos veh√≠culo
    ‚Üì
üë®‚Äçüíº Super Usuario verifica documentos ‚Üí ‚úÖ Aprobaci√≥n
    ‚Üì
üè¢ Creaci√≥n autom√°tica empresa fantasma ‚Üí üîó Asignaci√≥n conductor-veh√≠culo
    ‚Üì
üéØ Conductor listo para recibir ofertas
```

### **2. Registro de Conductor por Admin de Empresa**
*Solo admins de empresas verificadas pueden registrar usuarios*

```
üë®‚Äçüíº Admin empresa registra conductor ‚Üí üìß Notificaci√≥n al conductor
    ‚Üì
üì∏ Conductor sube documentos ‚Üí üë®‚Äçüíº Admin verifica
    ‚Üì
‚úÖ Conductor verificado ‚Üí üöõ Disponible para asignaci√≥n a veh√≠culos
```

### **3. Gesti√≥n de Veh√≠culos**

```
üë®‚Äçüíº Admin/Conductor registra veh√≠culo ‚Üí üì∏ Subida documentos
    ‚Üì
üë®‚Äçüíº Verificaci√≥n por admin ‚Üí ‚úÖ Veh√≠culo verificado
    ‚Üì
üë• Asignaci√≥n de conductores ‚Üí üîó Relaci√≥n drivers_vehicles
    ‚Üì
üéØ Veh√≠culo disponible para √≥rdenes
```

### **4. √ìrdenes de Transporte**

```
üìã Creaci√≥n orden (origen, destino, carga) ‚Üí üè¢ Asignaci√≥n empresa admin
    ‚Üì
üè™ Vinculaci√≥n empresa cliente (referencial) ‚Üí üöõ Asignaci√≥n veh√≠culo
    ‚Üì
üë§ Conductor asignado autom√°ticamente v√≠a veh√≠culo ‚Üí üì± Ejecuci√≥n orden
    ‚Üì
üìç Seguimiento tiempo real ‚Üí üìù Reportes de novedades ‚Üí ‚úÖ Finalizaci√≥n
```

### **5. Marketplace de Transporte**

#### **Escenario A: Empresa busca conductor**
```
üè¢ Empresa cliente publica oferta ‚Üí üì± Conductores naturales ven oferta
    ‚Üì
ü§ù Conductor acepta ‚Üí üìã Creaci√≥n orden autom√°tica
```

#### **Escenario B: Empresa ofrece servicios**
```
üè¢ Empresa transportadora publica capacidad ‚Üí üì± Empresas clientes ven ofertas
    ‚Üì
ü§ù Contrataci√≥n de servicio ‚Üí üìã Creaci√≥n orden
```

### **6. Sistema de Roles y Permisos**

#### **Super Usuario**
- ‚úÖ `absolute_permission` - Acceso total al sistema
- ‚úÖ `full_users_*` - Gesti√≥n global de usuarios
- ‚úÖ Registro y verificaci√≥n de empresas
- ‚úÖ Verificaci√≥n de conductores y veh√≠culos

#### **Admin de Empresa Verificada**
- ‚úÖ `comp_users_*` - Gesti√≥n usuarios de su empresa
- ‚úÖ Registro de conductores en su empresa
- ‚úÖ Verificaci√≥n de conductores y veh√≠culos propios
- ‚úÖ Asignaci√≥n conductor-veh√≠culo
- ‚úÖ Gesti√≥n de √≥rdenes de transporte

#### **Conductor Persona Natural**
- ‚úÖ Autoregistro v√≠a app m√≥vil (√öNICO m√©todo)
- ‚úÖ Registro de UN veh√≠culo propio
- ‚úÖ Recepci√≥n y ejecuci√≥n de √≥rdenes
- ‚ùå NO puede registrar otros usuarios

#### **Empresas Cliente**
- üìã Solo informaci√≥n referencial en √≥rdenes
- ‚ùå NO tienen usuarios en el sistema
- ‚ùå NO requieren autenticaci√≥n

### **7. Estados del Sistema**

| ID | Estado | Aplicaci√≥n |
|----|--------|------------|
| 100 | us_active | Usuarios activos |
| 101 | us_inactive | Usuarios inactivos |
| 102 | us_blocked | Usuarios bloqueados |
| 103 | us_driv_unverified | Conductores sin verificar |
| 104 | us_driv_verified_active | Conductores verificados activos |
| 105 | us_driv_verified_inactive | Conductores verificados inactivos |
| 106 | us_admin_active | Administrativos activos |
| 107 | us_admin_inactive | Administrativos inactivos |
| 108-111 | perm_*/rol_* | Permisos y roles |
| 112 | comp_unverified | Empresas sin verificar |
| 113 | comp_verified_active | Empresas verificadas activas |
| 114 | comp_verified_inactive | Empresas verificadas inactivas |

### **8. Flujo de Verificaci√≥n de Documentos**

```
üì∏ Subida documento ‚Üí üíæ Almacenamiento auth-service
    ‚Üì
üë®‚Äçüíº Revisi√≥n admin ‚Üí ‚úÖ/‚ùå Decisi√≥n
    ‚Üì
üì° Notificaci√≥n a servicio correspondiente ‚Üí üîÑ Actualizaci√≥n estado
    ‚Üì
üì± Usuario notificado del cambio (futuro sistema notificaciones)
```

## üìÑ Licencia

Este proyecto es privado y confidencial.
